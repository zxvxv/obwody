blueprint:
  name: "Obwody Krytyczne (Smart Recovery) v1.01"
  description: >
    System ochrony zasilania z INTELIGENTNYM POWROTEM.
    
    HISTORIA WERSJI:
    v1.01 - Dodano 5-sekundowÄ… zwÅ‚okÄ™ przy wykrywaniu awarii (Anty-Flicker).
            Zapobiega to wyÅ‚Ä…czaniu przy chwilowych spadkach napiÄ™cia.
            Zaktualizowano skÅ‚adniÄ™ service -> action.

    1. AWARIA SIECI (< Limit V przez 5s) -> WyÅ‚Ä…cza GRUPÄ˜ 1 (NajwiÄ™ksze odbiorniki).
    2. SÅABA BATERIA (< Limit 1) -> WyÅ‚Ä…cza GRUPÄ˜ 2 (Ostrzegawcze).
    3. PUSTA BATERIA (< Limit 2) -> WyÅ‚Ä…cza GRUPÄ˜ 3 (Reszta domu).
    
    POWRÃ“T ZASILANIA (Sekwencja Startu):
    Najpierw GRUPA 3 (NajwaÅ¼niejsze) -> potem GRUPA 2 -> na koÅ„cu GRUPA 1 (DuÅ¼e obciÄ…Å¼enia).
  domain: automation
  source_url: https://github.com/zxvxv/obwody/blob/main/blueprint.yaml
  input:
    # --- CZUJNIKI ---
    grid_voltage_l1:
      name: "Sensor NapiÄ™cia L1"
      default: sensor.deye_inverter_grid_l1_voltage
      selector:
        entity:
          domain: sensor
          device_class: voltage
    grid_voltage_l2:
      name: "Sensor NapiÄ™cia L2"
      default: sensor.deye_inverter_grid_l2_voltage
      selector:
        entity:
          domain: sensor
          device_class: voltage
    grid_voltage_l3:
      name: "Sensor NapiÄ™cia L3"
      default: sensor.deye_inverter_grid_l3_voltage
      selector:
        entity:
          domain: sensor
          device_class: voltage
    battery_soc:
      name: "Sensor Baterii (SOC)"
      default: sensor.deye_inverter_battery_bms_soc
      selector:
        entity:
          domain: sensor

    # --- PROGI ---
    voltage_limit:
      name: "PrÃ³g NapiÄ™cia - AWARIA (V)"
      default: 190
      selector:
        number:
          min: 150
          max: 230
          unit_of_measurement: V
          mode: box
    
    soc_limit_1:
      name: "PrÃ³g Baterii - OSTRZEGAWCZY (%)"
      default: 80
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
          mode: slider

    soc_limit_2:
      name: "PrÃ³g Baterii - KRYTYCZNY (%)"
      default: 20
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
          mode: slider

    # --- OBWODY ---
    targets_group_1:
      name: "GRUPA 1: Awaria Sieci / Hard Stop"
      description: "Te urzÄ…dzenia gasnÄ… PIERWSZE przy awarii (po 5s), a wstajÄ… OSTATNIE (DuÅ¼e AGD)."
      selector:
        target:
          entity:
            domain: switch

    targets_group_2:
      name: "GRUPA 2: SÅ‚aba Bateria"
      description: "Te urzÄ…dzenia gasnÄ… przy pierwszym progu (np. 80%)."
      selector:
        target:
          entity:
            domain: switch

    targets_group_3:
      name: "GRUPA 3: Pusta Bateria / Full Shutdown"
      description: "Te urzÄ…dzenia gasnÄ… OSTATNIE, a wstajÄ… PIERWSZE (Kluczowe systemy)."
      selector:
        target:
          entity:
            domain: switch

    # --- POWRÃ“T ---
    voltage_recovery:
      name: "PrÃ³g NapiÄ™cia - POWRÃ“T (V)"
      default: 215
      selector:
        number:
          min: 190
          max: 250
          unit_of_measurement: V
          mode: box

trigger:
  # ZMIANA v1.01: Dodano 'for: 5s'. Awaria musi trwaÄ‡ min. 5 sekund, Å¼eby wyÅ‚Ä…czyÄ‡ prÄ…d.
  - platform: numeric_state
    entity_id: !input grid_voltage_l1
    below: !input voltage_limit
    for: "00:00:05"
    id: grid_fail
  - platform: numeric_state
    entity_id: !input grid_voltage_l2
    below: !input voltage_limit
    for: "00:00:05"
    id: grid_fail
  - platform: numeric_state
    entity_id: !input grid_voltage_l3
    below: !input voltage_limit
    for: "00:00:05"
    id: grid_fail
  
  # Trigger SOC dziaÅ‚a natychmiastowo (bateria nie ma "skokÃ³w" jak napiÄ™cie)
  - platform: numeric_state
    entity_id: !input battery_soc
    below: !input soc_limit_1
    id: soc_1
  - platform: numeric_state
    entity_id: !input battery_soc
    below: !input soc_limit_2
    id: soc_2
  
  # PowrÃ³t wymaga stabilizacji przez 30 sekund (bez zmian)
  - platform: numeric_state
    entity_id: !input grid_voltage_l1
    above: !input voltage_recovery
    for: "00:00:30"
    id: grid_ok
  - platform: numeric_state
    entity_id: !input grid_voltage_l2
    above: !input voltage_recovery
    for: "00:00:30"
    id: grid_ok
  - platform: numeric_state
    entity_id: !input grid_voltage_l3
    above: !input voltage_recovery
    for: "00:00:30"
    id: grid_ok

action:
  - choose:
      - conditions:
          - condition: trigger
            id: grid_fail
        sequence:
          - action: persistent_notification.create
            data:
              title: "âš¡ AWARIA"
              message: "NapiÄ™cie poniÅ¼ej limitu przez >5s! WyÅ‚Ä…czam GrupÄ™ 1 (DuÅ¼e AGD)."
          - action: switch.turn_off
            target: !input targets_group_1
            
      - conditions:
          - condition: trigger
            id: soc_1
          # Warunek OR: SprawdÅº czy chociaÅ¼ jedna faza leÅ¼y, zanim wyÅ‚Ä…czysz z powodu baterii
          # (Chyba Å¼e chcesz chroniÄ‡ bateriÄ™ teÅ¼ przy normalnej pracy - wtedy usuÅ„ ten OR)
          - condition: or
            conditions:
              - condition: numeric_state
                entity_id: !input grid_voltage_l1
                below: !input voltage_limit
              - condition: numeric_state
                entity_id: !input grid_voltage_l2
                below: !input voltage_limit
              - condition: numeric_state
                entity_id: !input grid_voltage_l3
                below: !input voltage_limit
        sequence:
          - action: persistent_notification.create
            data:
              title: "ğŸ”‹ BATERIA SÅABA"
              message: "WyÅ‚Ä…czam GrupÄ™ 2."
          - action: switch.turn_off
            target: !input targets_group_2
            
      - conditions:
          - condition: trigger
            id: soc_2
          - condition: or
            conditions:
              - condition: numeric_state
                entity_id: !input grid_voltage_l1
                below: !input voltage_limit
              - condition: numeric_state
                entity_id: !input grid_voltage_l2
                below: !input voltage_limit
              - condition: numeric_state
                entity_id: !input grid_voltage_l3
                below: !input voltage_limit
        sequence:
          - action: persistent_notification.create
            data:
              title: "ğŸª« BATERIA KRYTYCZNA"
              message: "WyÅ‚Ä…czam GrupÄ™ 3 (Total Shutdown)."
          - action: switch.turn_off
            target: !input targets_group_3
            
      - conditions:
          - condition: trigger
            id: grid_ok
          - condition: numeric_state
            entity_id: !input grid_voltage_l1
            above: !input voltage_recovery
          - condition: numeric_state
            entity_id: !input grid_voltage_l2
            above: !input voltage_recovery
          - condition: numeric_state
            entity_id: !input grid_voltage_l3
            above: !input voltage_recovery
        sequence:
          - action: persistent_notification.create
            data:
              title: "âœ… POWRÃ“T ZASILANIA"
              message: "SieÄ‡ stabilna >30s. Przywracam zasilanie kaskadowo."
          # 1. Najpierw najwaÅ¼niejsze (Grupa 3)
          - delay: "00:00:05"
          - action: switch.turn_on
            target: !input targets_group_3
          # 2. Potem Å›rednie (Grupa 2)
          - delay: "00:00:05"
          - action: switch.turn_on
            target: !input targets_group_2
          # 3. Na koÅ„cu obciÄ…Å¼enia (Grupa 1)
          - delay: "00:00:05"
          - action: switch.turn_on
            target: !input targets_group_1
mode: restart
