blueprint:
  name: "ZarzÄ…dzanie Obwodami: Ochrona NapiÄ™ciowa i Bateryjna"
  description: >
    Automatyczny system zarzÄ…dzania obwodami (Load Shedding).
    
    JAK TO DZIAÅA:
    1. AWARIA SIECI (Spadek napiÄ™cia < Limit) -> WyÅ‚Ä…cza "Obwody Krytyczne" (np. Piekarnik).
    2. SÅABA BATERIA (SOC < Poziom 1) -> WyÅ‚Ä…cza "Obwody Ostrzegawcze" (np. GaraÅ¼).
    3. PUSTA BATERIA (SOC < Poziom 2) -> WyÅ‚Ä…cza "Obwody Ostateczne" (Reszta domu).
    
    POWRÃ“T: Gdy napiÄ™cie na wszystkich fazach wrÃ³ci powyÅ¼ej Limitu Powrotu.
  domain: automation
  # Link do Twojego repozytorium (uÅ‚atwia aktualizacje w przyszÅ‚oÅ›ci)
  source_url: https://github.com/zxvxv/obwody/blob/main/blueprint.yaml
  input:
    # --- CZUJNIKI (To co mierzy) ---
    grid_voltage_l1:
      name: Sensor NapiÄ™cia L1
      selector:
        entity:
          domain: sensor
          device_class: voltage
    grid_voltage_l2:
      name: Sensor NapiÄ™cia L2
      selector:
        entity:
          domain: sensor
          device_class: voltage
    grid_voltage_l3:
      name: Sensor NapiÄ™cia L3
      selector:
        entity:
          domain: sensor
          device_class: voltage
    battery_soc:
      name: Sensor Baterii (SOC)
      selector:
        entity:
          domain: sensor
          device_class: battery

    # --- KONFIGURACJA PROGÃ“W (Liczby) ---
    voltage_limit:
      name: PrÃ³g NapiÄ™cia - AWARIA (V)
      description: PoniÅ¼ej tego napiÄ™cia system uzna awariÄ™ i wyÅ‚Ä…czy pierwszÄ… grupÄ™.
      default: 190
      selector:
        number:
          min: 150
          max: 230
          unit_of_measurement: V
          mode: box
    
    soc_limit_1:
      name: PrÃ³g Baterii - OSTRZEGAWCZY (%)
      description: Przy ilu % wyÅ‚Ä…czyÄ‡ drugÄ… grupÄ™ urzÄ…dzeÅ„?
      default: 80
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
          mode: slider

    soc_limit_2:
      name: PrÃ³g Baterii - KRYTYCZNY (%)
      description: Przy ilu % wyÅ‚Ä…czyÄ‡ resztÄ™ domu (Total Shutdown)?
      default: 20
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
          mode: slider

    # --- WYBÃ“R OBWODÃ“W (To co wyÅ‚Ä…czamy) ---
    targets_group_1:
      name: GRUPA 1: Obwody do wyÅ‚Ä…czenia przy AWARII SIECI
      description: Wybierz urzÄ…dzenia, ktÃ³re gasnÄ… natychmiast przy zaniku fazy.
      selector:
        target:
          entity:
            domain: switch

    targets_group_2:
      name: GRUPA 2: Obwody do wyÅ‚Ä…czenia przy SÅABEJ BATERII
      description: Wybierz urzÄ…dzenia, ktÃ³re gasnÄ… przy pierwszym progu SOC.
      selector:
        target:
          entity:
            domain: switch

    targets_group_3:
      name: GRUPA 3: Obwody do wyÅ‚Ä…czenia przy PUSTEJ BATERII
      description: Wybierz urzÄ…dzenia, ktÃ³re gasnÄ… na samym koÅ„cu.
      selector:
        target:
          entity:
            domain: switch

    # --- POWRÃ“T ZASILANIA ---
    voltage_recovery:
      name: PrÃ³g NapiÄ™cia - POWRÃ“T (V)
      description: PowyÅ¼ej tego napiÄ™cia system przywrÃ³ci zasilanie.
      default: 215
      selector:
        number:
          min: 190
          max: 250
          unit_of_measurement: V
          mode: box

# --- LOGIKA DZIAÅANIA (Silnik) ---
trigger:
  # Awaria napiÄ™cia (L1, L2 lub L3)
  - platform: numeric_state
    entity_id: !input grid_voltage_l1
    below: !input voltage_limit
    id: grid_fail
  - platform: numeric_state
    entity_id: !input grid_voltage_l2
    below: !input voltage_limit
    id: grid_fail
  - platform: numeric_state
    entity_id: !input grid_voltage_l3
    below: !input voltage_limit
    id: grid_fail
    
  # Spadek SOC (Poziom 1)
  - platform: numeric_state
    entity_id: !input battery_soc
    below: !input soc_limit_1
    id: soc_1
    
  # Spadek SOC (Poziom 2)
  - platform: numeric_state
    entity_id: !input battery_soc
    below: !input soc_limit_2
    id: soc_2

  # PowrÃ³t napiÄ™cia (Wszystkie fazy OK)
  - platform: numeric_state
    entity_id: !input grid_voltage_l1
    above: !input voltage_recovery
    for: "00:00:30"
    id: grid_ok
  - platform: numeric_state
    entity_id: !input grid_voltage_l2
    above: !input voltage_recovery
    for: "00:00:30"
    id: grid_ok
  - platform: numeric_state
    entity_id: !input grid_voltage_l3
    above: !input voltage_recovery
    for: "00:00:30"
    id: grid_ok

action:
  - choose:
      # SCENARIUSZ 1: Brak prÄ…du / Niskie napiÄ™cie
      - conditions:
          - condition: trigger
            id: grid_fail
        sequence:
          - service: persistent_notification.create
            data:
              title: "âš¡ OCHRONA OBWODÃ“W"
              message: "NapiÄ™cie niskie! WyÅ‚Ä…czam GrupÄ™ 1 (AwaryjnÄ…)."
          - service: switch.turn_off
            target: !input targets_group_1

      # SCENARIUSZ 2: Bateria spada (Poziom 1)
      - conditions:
          - condition: trigger
            id: soc_1
          # Opcjonalnie: DziaÅ‚a tylko, jeÅ›li napiÄ™cie jest niskie (tryb off-grid)
          - condition: or
            conditions:
              - condition: numeric_state
                entity_id: !input grid_voltage_l1
                below: !input voltage_limit
              - condition: numeric_state
                entity_id: !input grid_voltage_l2
                below: !input voltage_limit
              - condition: numeric_state
                entity_id: !input grid_voltage_l3
                below: !input voltage_limit
        sequence:
          - service: persistent_notification.create
            data:
              title: "ğŸ”‹ OCHRONA BATERII (I stopieÅ„)"
              message: "Bateria sÅ‚abnie. WyÅ‚Ä…czam GrupÄ™ 2."
          - service: switch.turn_off
            target: !input targets_group_2

      # SCENARIUSZ 3: Bateria krytyczna (Poziom 2)
      - conditions:
          - condition: trigger
            id: soc_2
          - condition: or
            conditions:
              - condition: numeric_state
                entity_id: !input grid_voltage_l1
                below: !input voltage_limit
              - condition: numeric_state
                entity_id: !input grid_voltage_l2
                below: !input voltage_limit
              - condition: numeric_state
                entity_id: !input grid_voltage_l3
                below: !input voltage_limit
        sequence:
          - service: persistent_notification.create
            data:
              title: "ğŸª« OCHRONA BATERII (Krytyczna)"
              message: "Bateria rozÅ‚adowana! WyÅ‚Ä…czam GrupÄ™ 3."
          - service: switch.turn_off
            target: !input targets_group_3

      # SCENARIUSZ 4: PowrÃ³t zasilania
      - conditions:
          - condition: trigger
            id: grid_ok
          # SprawdÅº czy WSZYSTKIE 3 fazy sÄ… OK
          - condition: numeric_state
            entity_id: !input grid_voltage_l1
            above: !input voltage_recovery
          - condition: numeric_state
            entity_id: !input grid_voltage_l2
            above: !input voltage_recovery
          - condition: numeric_state
            entity_id: !input grid_voltage_l3
            above: !input voltage_recovery
        sequence:
          - service: persistent_notification.create
            data:
              title: "âœ… ZASILANIE PRZYWRÃ“CONE"
              message: "Parametry sieci OK. Uruchamiam obwody sekwencyjnie."
          - delay: "00:00:05"
          - service: switch.turn_on
            target: !input targets_group_1
          - delay: "00:00:05"
          - service: switch.turn_on
            target: !input targets_group_2
          - delay: "00:00:05"
          - service: switch.turn_on
            target: !input targets_group_3
mode: restart
